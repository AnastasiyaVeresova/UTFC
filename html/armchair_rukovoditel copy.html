<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style_menu_main.css">
    <link rel="stylesheet" href="../css/card.css">
    <script src="../script/products_lists/armchair_rukovoditel.js"></script>
    <title>Кресла для руководителей</title>
    <style>
        .product-tooltip {
            display: none;
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
            pointer-events: none;
            width: 250px;
            left: 100%;
            margin-left: 10px;
            top: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            line-height: 1.3;
        }

        .product-card:hover .product-tooltip {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Боковое меню -->
    <div class="sidebar">
        <ul>
            <li><a href="armchair_personal.html">Кресла для персонала</a></li>
            <li><a href="armchair_rukovoditel.html">Кресла для руководителей</a></li>
            <li><a href="chair_cafe_and_bar.html">Стулья для кафе и бара</a></li>
        </ul>
        <!-- Блок фильтра -->
        <div class="filter-block">
            <h3>Фильтр по высоте</h3>
            <div class="range-slider">
                <input type="range" id="minHeight" min="400" max="1200" step="10" value="400">
                <input type="range" id="maxHeight" min="400" max="1200" step="10" value="1200">
                <div class="range-track"></div>
            </div>
            <div class="range-values">
                <input type="number" id="minHeightValue" min="400" max="1200" step="10" value="400">
                <span>—</span>
                <input type="number" id="maxHeightValue" min="400" max="1200" step="10" value="1200">
            </div>
        </div>
    </div>
    <!-- Основной контент страницы -->
    <div class="center">
        <div class="content">
            <h1>Кресла для руководителей</h1>

            <div id="products"></div>
        </div>
    </div>
    <!-- Подключаем скрипт для загрузки карточек товаров -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const productsContainer = document.getElementById('products');
            if (!productsContainer) {
                console.error("Элемент #products не найден!");
                return;
            }
            const folderName = "armchair_rukovoditel";
            const products = [];
            const promises = knownProducts.map(productName => {
                return fetch(`../products/${folderName}/${productName}.json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка загрузки ${productName}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(product => {
                        product.namefile = product.namefile;
                        products.push(product);
                    })
                    .catch(error => {
                        console.error(`Ошибка загрузки ${productName}:`, error);
                    });
            });
            Promise.all(promises)
                .then(() => {
                    // Фильтруем только валидные товары
                    const validProducts = products.filter(p => p && p.namefile);
                    // Сортируем
                    validProducts.sort((a, b) => {
                        const aName = Array.isArray(a.namefile) ? a.namefile[0] : a.namefile;
                        const bName = Array.isArray(b.namefile) ? b.namefile[0] : b.namefile;
                        return aName.localeCompare(bName, 'ru');
                    });

                    // Генерируем карточки
                    validProducts.forEach(product => {
                        const productName = Array.isArray(product.name) && product.name.length > 0
                            ? product.name[0]
                            : product.name || 'Без названия';

                        // Получаем все параметры для всплывающей подсказки
                        const chairHeight = product.dimensions_details?.[0]?.chair_height;
                        const headrestHeight = product.dimensions_details?.[0]?.headrest_height;
                        const seatToFloorHeight = product.dimensions_details?.[0]?.seat_to_floor_height;
                        const armrestHeightFromSeat = product.dimensions_details?.[0]?.armrest_height_from_seat;
                        const chairDepth = product.dimensions_details?.[0]?.chair_depth;
                        const seatDepth = product.dimensions_details?.[0]?.seat_depth;
                        const backrestHeight = product.dimensions_details?.[0]?.backrest_height;
                        const backrestToSeatHeight = product.dimensions_details?.[0]?.backrest_to_seat_height;
                        const seatWidthWithArmrests = product.dimensions_details?.[0]?.seat_width_with_armrests;
                        const seatWidth = product.dimensions_details?.[0]?.seat_width;
                        const diameterCross = product.dimensions_details?.[0]?.diameter_cross;
                        const runnersWidth = product.dimensions_details?.[0]?.runners_width;
                        const runnersDepth = product.dimensions_details?.[0]?.runners_depth;
                        const maxLoad = product.guarantee?.[0]?.max_load;
                        const boxSize = product.transportation?.[0]?.packaging?.box_size;
                        const brutto = product.dimensions?.[0]?.brutto;
                        const netto = product.dimensions?.[0]?.netto;
                        const volume = product.dimensions?.[0]?.volume;
                        const upholstery = product.construction_and_materials?.[0]?.upholstery_materials?.[0];

                        // Формируем текст для всплывающей подсказки
                        let tooltipText = `
                            <strong>${productName}</strong><br><br>
                            ${upholstery ? `<strong>Материал облицовки:</strong> ${upholstery.replace(/-.*/g, '').trim()}<br>` : ''}
                            ${boxSize ? `<strong>Размер коробки:</strong> ${boxSize}<br>` : ''}
                            ${brutto ? `<strong>Вес брутто:</strong> ${brutto} кг<br>` : ''}
                            ${netto ? `<strong>Вес нетто:</strong> ${netto} кг<br>` : ''}
                            ${volume ? `<strong>Объем:</strong> ${volume} м³<br>` : ''}
                            ${maxLoad ? `<strong>Макс. нагрузка:</strong> ${maxLoad} кг<br>` : ''}
                            ${chairHeight?.min || chairHeight?.max ? `<strong>Высота кресла:</strong> ${chairHeight.min || ''} - ${chairHeight.max || ''} мм<br>` : ''}
                            ${headrestHeight?.min || headrestHeight?.max ? `<strong>Высота подголовника:</strong> ${headrestHeight.min || ''} - ${headrestHeight.max || ''} мм<br>` : ''}
                            ${seatToFloorHeight?.min || seatToFloorHeight?.max ? `<strong>Высота сиденья от пола:</strong> ${seatToFloorHeight.min || ''} - ${seatToFloorHeight.max || ''} мм<br>` : ''}
                            ${armrestHeightFromSeat?.min || armrestHeightFromSeat?.max ? `<strong>Высота подлокотников от сиденья:</strong> ${armrestHeightFromSeat.min || ''} - ${armrestHeightFromSeat.max || ''} мм<br>` : ''}
                            ${chairDepth?.min || chairDepth?.max ? `<strong>Глубина кресла:</strong> ${chairDepth.min || ''} - ${chairDepth.max || ''} мм<br>` : ''}
                            ${seatDepth?.min || seatDepth?.max ? `<strong>Глубина сиденья:</strong> ${seatDepth.min || ''} - ${seatDepth.max || ''} мм<br>` : ''}
                            ${backrestHeight?.min || backrestHeight?.max ? `<strong>Высота спинки:</strong> ${backrestHeight.min || ''} - ${backrestHeight.max || ''} мм<br>` : ''}
                            ${backrestToSeatHeight?.min || backrestToSeatHeight?.max ? `<strong>Высота спинки от сиденья:</strong> ${backrestToSeatHeight.min || ''} - ${backrestToSeatHeight.max || ''} мм<br>` : ''}
                            ${seatWidthWithArmrests?.min || seatWidthWithArmrests?.max ? `<strong>Ширина сиденья с подлокотниками:</strong> ${seatWidthWithArmrests.min || ''} - ${seatWidthWithArmrests.max || ''} мм<br>` : ''}
                            ${seatWidth?.min || seatWidth?.max ? `<strong>Ширина сиденья:</strong> ${seatWidth.min || ''} - ${seatWidth.max || ''} мм<br>` : ''}
                            ${diameterCross?.min || diameterCross?.max ? `<strong>Диаметр крестовины:</strong> ${diameterCross.min || ''} - ${diameterCross.max || ''} мм<br>` : ''}
                            ${runnersWidth?.min || runnersWidth?.max ? `<strong>Ширина полозьев:</strong> ${runnersWidth.min || ''} - ${runnersWidth.max || ''} мм<br>` : ''}
                            ${runnersDepth?.min || runnersDepth?.max ? `<strong>Глубина полозьев:</strong> ${runnersDepth.min || ''} - ${runnersDepth.max || ''} мм<br>` : ''}
                        `;

                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        productCard.innerHTML = `
                            <div class="product-tooltip">${tooltipText}</div>
                            <img src="${product.images?.[0]?.vid_main || ''}" alt="${productName}">
                            <a href="card.html?category=armchair_rukovoditel&name=${encodeURIComponent(productName)}">${productName}</a>
                        `;
                        productsContainer.appendChild(productCard);
                    });

                    if (validProducts.length === 0) {
                        productsContainer.innerHTML = '<p>Товары не найдены.</p>';
                    }

                    // --- Логика фильтрации ---
                    const minHeightInput = document.getElementById('minHeight');
                    const maxHeightInput = document.getElementById('maxHeight');
                    const minHeightValue = document.getElementById('minHeightValue');
                    const maxHeightValue = document.getElementById('maxHeightValue');
                    // Устанавливаем min/max на основе данных
                    let minPossible = Infinity;
                    let maxPossible = -Infinity;
                    validProducts.forEach(product => {
                        const chairHeight = product.dimensions_details?.[0]?.chair_height;
                        if (chairHeight) {
                            if (chairHeight.min && chairHeight.min < minPossible) minPossible = chairHeight.min;
                            if (chairHeight.max && chairHeight.max > maxPossible) maxPossible = chairHeight.max;
                        }
                    });
                    if (minPossible !== Infinity) {
                        minHeightInput.min = minPossible;
                        minHeightValue.min = minPossible;
                        minHeightInput.value = minPossible;
                        minHeightValue.value = minPossible;
                    } else {
                        minHeightInput.value = 0;
                        minHeightValue.value = 0;
                    }
                    if (maxPossible !== -Infinity) {
                        maxHeightInput.max = maxPossible;
                        maxHeightValue.max = maxPossible;
                        maxHeightInput.value = maxPossible;
                        maxHeightValue.value = maxPossible;
                    } else {
                        maxHeightInput.value = 0;
                        maxHeightValue.value = 0;
                    }
                    // Синхронизация ползунков и полей ввода
                    minHeightInput.addEventListener('input', () => {
                        if (parseInt(minHeightInput.value) > parseInt(maxHeightInput.value)) {
                            minHeightInput.value = maxHeightInput.value;
                        }
                        minHeightValue.value = minHeightInput.value;
                        filterProducts();
                    });
                    maxHeightInput.addEventListener('input', () => {
                        if (parseInt(maxHeightInput.value) < parseInt(minHeightInput.value)) {
                            maxHeightInput.value = minHeightInput.value;
                        }
                        maxHeightValue.value = maxHeightInput.value;
                        filterProducts();
                    });
                    minHeightValue.addEventListener('change', () => {
                        if (parseInt(minHeightValue.value) > parseInt(maxHeightInput.value)) {
                            minHeightValue.value = maxHeightInput.value;
                        }
                        minHeightInput.value = minHeightValue.value;
                        filterProducts();
                    });
                    maxHeightValue.addEventListener('change', () => {
                        if (parseInt(maxHeightValue.value) < parseInt(minHeightInput.value)) {
                            maxHeightValue.value = minHeightInput.value;
                        }
                        maxHeightInput.value = maxHeightValue.value;
                        filterProducts();
                    });

                    function filterProducts() {
                        const min = parseInt(minHeightInput.value);
                        const max = parseInt(maxHeightInput.value);
                        const productCards = document.querySelectorAll('.product-card');
                        let visibleProductsCount = 0; // Счётчик видимых товаров
                        // Сначала скрываем все карточки
                        productCards.forEach(card => {
                            card.style.display = 'none';
                        });
                        // Затем проверяем, какие карточки нужно показать
                        productCards.forEach(card => {
                            const productName = card.querySelector('a').textContent;
                            const product = validProducts.find(p => {
                                const pName = Array.isArray(p.name) ? p.name[0] : p.name;
                                return pName === productName;
                            });
                            if (!product) {
                                return;
                            }
                            const chairHeight = product.dimensions_details?.[0]?.chair_height;
                            if (!chairHeight) {
                                card.style.display = 'inline-block';
                                visibleProductsCount++;
                                return;
                            }
                            // Приводим значения высоты к числам
                            const minHeight = chairHeight.min ? parseInt(chairHeight.min) : null;
                            const maxHeight = chairHeight.max ? parseInt(chairHeight.max) : null;
                            let isInRange = false;
                            // Если указаны обе границы высоты кресла
                            if (minHeight !== null && maxHeight !== null) {
                                isInRange = (minHeight >= min && maxHeight <= max);
                            }
                            // Если указана только минимальная высота
                            else if (minHeight !== null) {
                                isInRange = (minHeight >= min && minHeight <= max);
                            }
                            // Если указана только максимальная высота
                            else if (maxHeight !== null) {
                                isInRange = (maxHeight >= min && maxHeight <= max);
                            }
                            if (isInRange || (!minHeight && !maxHeight)) {
                                card.style.display = 'inline-block';
                                visibleProductsCount++;
                            }
                        });
                        // Если нет видимых товаров, выводим сообщение
                        const noProductsMessage = document.querySelector('#products > p');
                        if (visibleProductsCount === 0) {
                            if (!noProductsMessage) {
                                productsContainer.insertAdjacentHTML('beforeend', '<p>Товары не найдены. Рекомендуем изменить условия фильтрации</p>');
                            }
                        } else {
                            if (noProductsMessage) {
                                noProductsMessage.remove();
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки данных:', error);
                    productsContainer.innerHTML = '<p>Не удалось загрузить товары. Попробуйте позже.</p>';
                });
        });
    </script>
</body>
</html>
